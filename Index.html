<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HASAN TELECOM - Pro Vault</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">

    <!-- PWA manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">
    <link rel="icon" href="icon-192.png">

    <!-- jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; }
        input::placeholder { color: #64748b; }
        .group-header:hover { cursor: pointer; background-color: rgba(59,130,246,0.05); }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-950 text-slate-100 min-h-screen p-4 md:p-8 flex flex-col items-center gap-6">

<!-- App Container -->
<div class="w-full max-w-xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-[32px] p-8 flex flex-col items-center text-center shadow-2xl">
    <h1 class="text-3xl font-black text-blue-600 dark:text-blue-500 tracking-tighter uppercase mb-1">
        HASAN TELECOM
    </h1>
    <p id="modeIndicator" class="text-[10px] text-slate-400 font-bold tracking-[0.2em] uppercase mb-6">
        STAFF VIEW MODE
    </p>

    <div class="flex items-center gap-4">
        <button onclick="toggleTheme()" class="bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-4 rounded-2xl hover:scale-105 transition">
            <span id="themeIcon" class="text-xl">üåô</span>
        </button>
        <button id="adminBtn" onclick="toggleAdmin()" class="bg-blue-600 text-white px-10 py-4 rounded-2xl font-black uppercase text-sm tracking-widest shadow-lg shadow-blue-900/40 hover:bg-blue-500 transition">
            LOGIN
        </button>
        <div id="adminTools" class="hidden flex gap-2">
            <button onclick="generatePDF()" title="Export PDF Based on Search" class="bg-orange-600 p-4 rounded-2xl text-white shadow-lg hover:bg-orange-500 transition">üìÑ</button>
            <button onclick="logout()" title="Logout" class="bg-red-600 p-4 rounded-2xl text-white shadow-lg hover:bg-red-500 transition">‚úï</button>
        </div>
    </div>
</div>

<div class="w-full max-w-xl bg-white dark:bg-slate-900/50 border border-slate-200 dark:border-slate-800 rounded-[32px] p-6 space-y-4 shadow-xl mt-6">
    <div class="relative">
        <input type="text" id="searchInput" onkeyup="render()" placeholder="Search (e.g. 'Logic Board' or 'S21')" class="w-full bg-slate-100 dark:bg-slate-950 border border-slate-200 dark:border-slate-700 p-5 rounded-2xl text-slate-900 dark:text-slate-300 outline-none focus:ring-2 focus:ring-blue-500 transition">
        <span class="absolute right-5 top-5 opacity-20">üîç</span>
    </div>
</div>

<div id="vaultContent" class="w-full max-w-xl space-y-3 mt-4"></div>
<div id="emptyState" class="hidden p-20 text-center text-slate-400 font-bold uppercase text-xs italic">No items found matching your filter</div>

<script>
/* ------------------ CONFIG ------------------ */
// Admin password
const ADMIN_PASSWORD = "511436";
const BRANDS = ["SAMSUNG","XIAOMI","OPPO","VIVO","REALME","IPHONE","HUAWEI","ONEPLUS","ITEL","TECNO","INFINIX","GOOGLE PIXEL","SYMPHONY","NOKIA","MOTOROLA","NOTHING PHONE"];
const CATEGORIES = ["Logic Board","Front Camera","Main Flex","LCD Flex","Finger Sensor","Ringer Box","Ear Speaker","Sim Tray","Power Flex","Volume Flex","Rubber switch","Camera Glass","Speaker Net","Middle Frame","Housing","Back Part"];

// Firebase config
const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_PROJECT.appspot.com",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// App state
let isAdmin = false;
let expandedModels = new Set();

/* ------------------ UTILS ------------------ */
function toTitleCase(str){
    return str.toLowerCase().split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
}

/* ------------------ THEME ------------------ */
function toggleTheme() {
    const isDark = document.documentElement.classList.toggle('dark');
    localStorage.setItem('theme', isDark ? 'dark' : 'light');
    document.getElementById('themeIcon').innerText = isDark ? '‚òÄÔ∏è' : 'üåô';
}
if(localStorage.theme === 'light'){ document.documentElement.classList.remove('dark'); document.getElementById('themeIcon').innerText='üåô'; }

/* ------------------ ADMIN ------------------ */
function toggleAdmin(){
    if(prompt("Admin Key:") === ADMIN_PASSWORD){
        isAdmin = true;
        updateUI();
    }
}
function logout(){
    isAdmin = false;
    updateUI();
}
function updateUI(){
    document.getElementById('adminBtn').classList.toggle('hidden', isAdmin);
    document.getElementById('adminTools').classList.toggle('hidden', !isAdmin);
    document.getElementById('modeIndicator').innerText = isAdmin ? "ADMIN AUTHORIZED" : "STAFF VIEW MODE";
    render();
}

/* ------------------ FIRESTORE DATA ------------------ */
async function addOrUpdateItem(item){
    // Check if exists
    const snapshot = await db.collection("inventory")
        .where("name", "==", item.name)
        .where("brand", "==", item.brand)
        .where("cat", "==", item.cat)
        .get();
    
    if(!snapshot.empty){
        snapshot.docs.forEach(doc => doc.ref.update(item));
    } else {
        await db.collection("inventory").add(item);
    }
}

async function getAllItems(){
    const snapshot = await db.collection("inventory").orderBy("brand").get();
    return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
}

async function deleteItem(id){
    if(confirm("Delete this item?")) {
        await db.collection("inventory").doc(id).delete();
        render();
    }
}

async function toggleStock(id, current){
    if(!isAdmin) return;
    await db.collection("inventory").doc(id).update({ inStock: !current });
    render();
}

/* ------------------ RENDER ------------------ */
async function render(){
    const vault = document.getElementById('vaultContent');
    const emptyState = document.getElementById('emptyState');
    const search = document.getElementById('searchInput').value.toLowerCase();

    let data = await getAllItems();

    // Filter
    const searchTerms = search.split(' ').filter(t=>t!=='');
    data = data.filter(i=>{
        const combined = `${i.brand} ${i.name} ${i.cat}`.toLowerCase();
        return searchTerms.every(t=>combined.includes(t));
    });

    // Group by model
    const groups = data.reduce((acc,i)=>{
        if(!acc[i.name]) acc[i.name]=[];
        acc[i.name].push(i);
        return acc;
    },{});

    vault.innerHTML = '';
    const names = Object.keys(groups).sort();
    names.forEach(model=>{
        const items = groups[model];
        const isExpanded = expandedModels.has(model);
        const brand = items[0].brand;

        let html = `
        <div class="bg-white dark:bg-slate-900 rounded-2xl border border-slate-200 dark:border-slate-800 overflow-hidden shadow-sm">
            <div class="group-header p-4 flex justify-between items-center" onclick="toggleModel('${model}')">
                <div>
                    <span class="text-xs font-black text-orange-500 uppercase tracking-widest bg-orange-100 dark:bg-orange-900/30 px-2 py-1 rounded-lg">${brand}</span>
                    <h3 class="text-lg font-bold dark:text-white mt-1">${model}</h3>
                </div>
                <span class="${isExpanded?'rotate-180':''} opacity-30">‚ñº</span>
            </div>
            <div class="${isExpanded?'block':'hidden'} border-t border-slate-100 dark:border-slate-800 bg-slate-50 dark:bg-slate-950/50">
                <table class="w-full text-sm">
                    <tbody class="divide-y divide-slate-200 dark:divide-slate-800">
                        ${items.map(i=>{
                            const priceDisplay = (i.price==="Contact" && isAdmin)
                                ? `<button onclick="promptSetPrice('${i.id}')" class="bg-blue-600 text-[10px] text-white px-3 py-1 rounded-lg font-bold">SET PRICE</button>` 
                                : i.price;
                            return `<tr>
                                <td class="px-6 py-2 font-bold text-slate-600 dark:text-slate-400 text-xs uppercase">${i.cat}</td>
                                <td class="px-2 py-2 cursor-pointer text-[9px] font-black" onclick="toggleStock('${i.id}', ${i.inStock})">
                                    ${i.inStock?'<span class="text-emerald-500">üü¢ IN STOCK</span>':'<span class="text-red-500">üî¥ OUT</span>'}
                                </td>
                                <td class="px-6 py-2 text-right font-mono font-bold text-blue-600 dark:text-blue-400">${priceDisplay}</td>
                                ${isAdmin?`<td class="w-10 pr-4 text-right"><button onclick="deleteItem('${i.id}')" class="text-red-500 font-bold hover:text-red-700">‚úï</button></td>`:''}
                            </tr>`;
                        }).join('')}
                    </tbody>
                </table>
            </div>
        </div>
        `;
        vault.innerHTML += html;
    });

    emptyState.classList.toggle('hidden', names.length>0);
}

/* ------------------ HELPER ------------------ */
function toggleModel(name){
    if(expandedModels.has(name)) expandedModels.delete(name);
    else expandedModels.add(name);
    render();
}

function promptSetPrice(id){
    const newPrice = prompt("Enter new price:");
    if(newPrice!==null){
        db.collection("inventory").doc(id).update({ price: newPrice });
        render();
    }
}

/* ------------------ PDF ------------------ */
async function generatePDF(){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const data = await getAllItems();

    if(data.length===0){ return alert("No items to export."); }

    doc.setFontSize(20);
    doc.setTextColor(37, 99, 235);
    doc.text("HASAN TELECOM - INVENTORY REPORT",14,20);
    doc.setFontSize(10);
    doc.setTextColor(100);
    doc.text(`Date: ${new Date().toLocaleDateString()}`,14,28);

    const rows = data.map(i=>[i.brand,i.name,i.cat,i.inStock?"YES":"NO",i.price]);
    doc.autoTable({
        startY:35,
        head:[['Brand','Model','Category','Available','Price']],
        body:rows,
        headStyles:{ fillColor:[37,99,235], fontSize:10, fontStyle:'bold' },
        alternateRowStyles:{ fillColor:[245,247,250] },
        columnStyles:{4:{halign:'right', fontStyle:'bold'}}
    });

    doc.save(`HasanTelecom_Report_${new Date().toISOString().split('T')[0]}.pdf`);
}

/* ------------------ INIT ------------------ */
render();
</script>
</body>
</html>
