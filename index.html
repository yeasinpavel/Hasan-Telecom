<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HASAN TELECOM - Pro Vault v2.2</title>

    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="logo.png">
    <link rel="apple-touch-icon" href="logo.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="HT Vault">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>tailwind.config = { darkMode: 'class' }</script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .group-header:hover { cursor: pointer; background-color: rgba(59, 130, 246, 0.05); }
        #vaultContent > div { content-visibility: auto; contain-intrinsic-size: 80px; }
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-950 text-slate-900 dark:text-slate-100 min-h-screen p-4 md:p-8 flex flex-col items-center gap-6 transition-colors duration-300">

    <div class="w-full max-w-xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-[32px] p-8 flex flex-col items-center text-center shadow-2xl">
        <h1 class="text-3xl font-black text-blue-600 dark:text-blue-500 tracking-tighter uppercase mb-1">HASAN TELECOM</h1>
        <p id="modeIndicator" class="text-[10px] text-slate-400 font-bold tracking-[0.2em] uppercase mb-6">STAFF VIEW MODE</p>
        <div class="flex items-center gap-4">
            <button onclick="toggleTheme()" class="bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-4 rounded-2xl hover:scale-105 transition">
                <span id="themeIcon" class="text-xl">ðŸŒ™</span>
            </button>
            <button id="adminBtn" onclick="toggleAdmin()" class="bg-blue-600 text-white px-10 py-4 rounded-2xl font-black uppercase text-sm tracking-widest shadow-lg hover:bg-blue-500 transition">LOGIN</button>
            <div id="adminTools" class="hidden flex gap-2">
                <button onclick="generatePDF()" title="Export PDF" class="bg-orange-600 p-4 rounded-2xl text-white shadow-lg">ðŸ“„</button>
                <button onclick="downloadBackup()" title="Backup" class="bg-emerald-600 p-4 rounded-2xl text-white shadow-lg">ðŸ’¾</button>
                <button onclick="logout()" title="Logout" class="bg-red-600 p-4 rounded-2xl text-white shadow-lg">âœ•</button>
            </div>
        </div>
    </div>

    <div id="statsPanel" class="hidden w-full max-w-xl grid grid-cols-3 gap-3">
        <div class="bg-white dark:bg-slate-900 p-4 rounded-2xl border border-slate-200 dark:border-slate-800 text-center">
            <p class="text-[10px] text-slate-400 font-bold uppercase">Total</p>
            <p id="statTotal" class="text-xl font-black text-blue-500">0</p>
        </div>
        <div class="bg-white dark:bg-slate-900 p-4 rounded-2xl border border-slate-200 dark:border-slate-800 text-center">
            <p class="text-[10px] text-slate-400 font-bold uppercase">Out</p>
            <p id="statLow" class="text-xl font-black text-red-500">0</p>
        </div>
        <div class="bg-white dark:bg-slate-900 p-4 rounded-2xl border border-slate-200 dark:border-slate-800 text-center">
            <p class="text-[10px] text-slate-400 font-bold uppercase">Brands</p>
            <p id="statBrands" class="text-xl font-black text-emerald-500">0</p>
        </div>
    </div>

    <div id="adminPanel" class="hidden w-full max-w-xl bg-white dark:bg-slate-900 p-6 rounded-[32px] border-2 border-blue-600 shadow-2xl space-y-4">
        <div class="grid grid-cols-2 gap-4">
            <select id="modelBrand" class="bg-slate-100 dark:bg-slate-800 p-4 rounded-xl outline-none font-bold dark:text-white"></select>
            <select id="modelCategory" class="bg-slate-100 dark:bg-slate-800 p-4 rounded-xl outline-none font-bold dark:text-white"></select>
        </div>
        <textarea id="bulkInput" rows="3" placeholder="Model, Price" class="w-full bg-slate-100 dark:bg-slate-800 p-4 rounded-xl outline-none font-mono text-sm dark:text-white"></textarea>
        <div class="grid grid-cols-2 gap-4">
            <button onclick="addOrUpdate()" class="bg-blue-600 text-white py-4 rounded-2xl font-black uppercase tracking-widest">SAVE</button>
            <label class="bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-white py-4 rounded-2xl font-black uppercase text-center cursor-pointer text-xs flex items-center justify-center">
                IMPORT <input type="file" id="importFile" class="hidden" onchange="importBackup(event)">
            </label>
        </div>
    </div>

    <div class="w-full max-w-xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-[32px] p-6 space-y-4 shadow-xl">
        <input type="text" id="searchInput" oninput="debouncedRender()" placeholder="Search..." class="w-full bg-slate-100 dark:bg-slate-950 p-5 rounded-2xl outline-none focus:ring-2 focus:ring-blue-500 dark:text-white">
        <select id="filterBrand" onchange="render()" class="w-full bg-slate-100 dark:bg-slate-800 p-5 rounded-2xl font-black text-orange-600 dark:text-orange-500"></select>
    </div>

    <div id="vaultContent" class="w-full max-w-xl space-y-3 pb-20"></div>
    <div id="emptyState" class="hidden p-20 text-center text-slate-400 font-bold italic">No items found</div>

    <script>
        const ADMIN_KEY_ENCODED = "MTIzNA=="; // "511436"
        const BRANDS = ["SAMSUNG", "XIAOMI", "OPPO", "VIVO", "REALME", "IPHONE", "HUAWEI", "ONEPLUS", "ITEL", "TECNO", "INFINIX","GOOGLE PIXEL", "SYMPHONY", "NOKIA", "MOTOROLA", "NOTHING PHONE"];
        const CATEGORIES = ["Logic Board", "Front Camera", "Main Flex", "LCD Flex", "Finger Sensor", "Ringer Box", "Ear Speaker", "Sim Tray", "Power Flex", "Volume Flex", "Rubber switch", "Camera Glass", "Speaker Net", "Middle Frame", "Housing", "Back Part"];

        let data = JSON.parse(localStorage.getItem('ht_vault_v2')) || [];
        let isAdmin = false;
        let expandedModels = new Set();
        let searchTimer;

        function toTitleCase(s) { return s.toLowerCase().split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' '); }
        function toggleTheme() {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            document.getElementById('themeIcon').innerText = isDark ? 'â˜€ï¸' : 'ðŸŒ™';
        }
        if (localStorage.theme === 'light') { document.documentElement.classList.remove('dark'); }

        function toggleAdmin() {
            const p = prompt("Key:");
            if (p && btoa(p) === ADMIN_KEY_ENCODED) { isAdmin = true; updateUI(); }
        }
        function logout() { isAdmin = false; updateUI(); }

        function updateUI() {
            document.getElementById('adminPanel').classList.toggle('hidden', !isAdmin);
            document.getElementById('adminTools').classList.toggle('hidden', !isAdmin);
            document.getElementById('statsPanel').classList.toggle('hidden', !isAdmin);
            document.getElementById('adminBtn').classList.toggle('hidden', isAdmin);
            document.getElementById('modeIndicator').innerText = isAdmin ? "ADMIN AUTHORIZED" : "STAFF VIEW MODE";
            render();
        }

        function addOrUpdate() {
            const bulk = document.getElementById('bulkInput').value;
            const brand = document.getElementById('modelBrand').value;
            const cat = document.getElementById('modelCategory').value;
            bulk.split('\n').forEach(line => {
                if(!line.trim()) return;
                let [rawName, price = "Contact"] = line.split(',').map(s => s.trim());
                const name = toTitleCase(rawName);
                const ex = data.find(i => i.name.toLowerCase() === name.toLowerCase() && i.cat === cat && i.brand === brand);
                if (ex) ex.price = price;
                else data.push({ id: Date.now() + Math.random(), name, price, cat, brand, inStock: true });
            });
            saveAndRender();
            document.getElementById('bulkInput').value = '';
        }

        function debouncedRender() { clearTimeout(searchTimer); searchTimer = setTimeout(render, 150); }

        function render() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const brandFilter = document.getElementById('filterBrand').value;
            const container = document.getElementById('vaultContent');
            
            if(!document.getElementById('modelBrand').innerHTML) {
                document.getElementById('modelBrand').innerHTML = BRANDS.map(b => `<option value="${b}">${b}</option>`).join('');
                document.getElementById('modelCategory').innerHTML = CATEGORIES.map(c => `<option value="${c}">${c}</option>`).join('');
                document.getElementById('filterBrand').innerHTML = `<option value="ALL">ALL BRANDS</option>` + BRANDS.map(b => `<option value="${b}">${b}</option>`).join('');
            }

            const searchTerms = search.split(' ').filter(t => t !== '');
            let outCount = 0; const brandsFound = new Set();

            const filtered = data.filter(i => {
                const blob = `${i.brand} ${i.name} ${i.cat}`.toLowerCase();
                const match = searchTerms.every(t => blob.includes(t)) && (brandFilter === "ALL" || i.brand === brandFilter);
                if (match) { if(!i.inStock) outCount++; brandsFound.add(i.brand); }
                return match;
            });

            if(isAdmin) {
                document.getElementById('statTotal').innerText = filtered.length;
                document.getElementById('statLow').innerText = outCount;
                document.getElementById('statBrands').innerText = brandsFound.size;
            }

            const groups = filtered.reduce((acc, item) => { (acc[item.name] = acc[item.name] || []).push(item); return acc; }, {});

            let htmlBuffer = '';
            Object.keys(groups).sort().forEach(modelName => {
                const items = groups[modelName]; const isExpanded = expandedModels.has(modelName);
                htmlBuffer += `
                    <div class="bg-white dark:bg-slate-900 rounded-[24px] border border-slate-200 dark:border-slate-800 overflow-hidden shadow-sm">
                        <div onclick="toggleModel('${modelName}')" class="group-header p-5 flex justify-between items-center select-none">
                            <div class="flex flex-col gap-1">
                                <span class="text-[9px] font-black text-orange-500 bg-orange-100 dark:bg-orange-900/20 px-2 py-1 rounded-md border border-orange-100 dark:border-orange-800">${items[0].brand}</span>
                                <h3 class="text-lg font-bold dark:text-white">${modelName}</h3>
                            </div>
                            <span class="transform transition-transform ${isExpanded ? 'rotate-180' : ''} opacity-30">â–¼</span>
                        </div>
                        <div class="${isExpanded ? 'block' : 'hidden'} border-t border-slate-100 dark:border-slate-800 bg-slate-50 dark:bg-slate-950/50">
                            <table class="w-full text-sm">
                                <tbody class="divide-y divide-slate-200 dark:divide-slate-800">
                                    ${items.map(item => `
                                        <tr>
                                            <td class="px-6 py-4 font-bold text-slate-600 dark:text-slate-400 text-xs uppercase">${item.cat}</td>
                                            <td onclick="toggleStock(${item.id})" class="px-2 py-4 cursor-pointer text-[9px] font-black text-center">
                                                ${item.inStock ? '<span class="text-emerald-500">IN STOCK</span>' : '<span class="text-red-500">OUT</span>'}
                                            </td>
                                            <td class="px-6 py-4 text-right font-mono font-bold text-blue-600 dark:text-blue-400">
                                                ${(item.price === "Contact" && isAdmin) ? `<button onclick="modifyPrice(${item.id})" class="bg-blue-600 text-[10px] text-white px-3 py-1 rounded-lg">SET</button>` : 'à§³'+item.price}
                                            </td>
                                            ${isAdmin ? `<td class="w-10 pr-4 text-right"><button onclick="deleteItem(${item.id})" class="text-red-400">âœ•</button></td>` : ''}
                                        </tr>`).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>`;
            });
            container.innerHTML = htmlBuffer;
            document.getElementById('emptyState').classList.toggle('hidden', filtered.length > 0);
        }

        function modifyPrice(id) { const p = prompt("Price:"); if (p !== null) { const i = data.find(x => x.id === id); if (i) { i.price = p.trim() || "Contact"; saveAndRender(); } } }
        function toggleStock(id) { if(isAdmin) { const i = data.find(x => x.id === id); if(i) { i.inStock = !i.inStock; saveAndRender(); } } }
        function deleteItem(id) { if(confirm("Delete?")) { data = data.filter(x => x.id !== id); saveAndRender(); } }
        function toggleModel(m) { if(expandedModels.has(m)) expandedModels.delete(m); else expandedModels.add(m); render(); }
        function saveAndRender() { localStorage.setItem('ht_vault_v2', JSON.stringify(data)); render(); }
        function downloadBackup() { const blob = new Blob([JSON.stringify(data)], { type: 'application/json' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `HT_Backup.json`; a.click(); }
        function importBackup(e) { const reader = new FileReader(); reader.onload = (ev) => { try { data = JSON.parse(ev.target.result); saveAndRender(); alert("Imported!"); } catch(e) { alert("Error"); } }; reader.readAsText(e.target.files[0]); }
        function generatePDF() {
            const { jsPDF } = window.jspdf; const doc = new jsPDF();
            const rows = data.map(i => [i.brand, i.name, i.cat, i.inStock?"YES":"NO", i.price]);
            doc.text("HASAN TELECOM", 14, 15);
            doc.autoTable({ head: [['Brand', 'Model', 'Category', 'Stock', 'Price']], body: rows, startY: 20 });
            doc.save("Inventory.pdf");
        }

        if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js'); }); }
        render();
    </script>
</body>
</html>
