<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HASAN TELECOM - Pro Vault v2.2</title>

    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="logo.png">
    <link rel="apple-touch-icon" href="logo.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="HT Vault">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>tailwind.config = { darkMode: 'class' }</script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .group-header:hover { cursor: pointer; background-color: rgba(59, 130, 246, 0.05); }
        /* SPEED OPTIMIZATION: Only render what is on screen */
        #vaultContent > div { content-visibility: auto; contain-intrinsic-size: 80px; }
        input::placeholder { color: #64748b; }
        /* Hides scrollbar for cleaner app look */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .dark ::-webkit-scrollbar-thumb { background: #334155; }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-950 text-slate-900 dark:text-slate-100 min-h-screen p-4 md:p-8 flex flex-col items-center gap-6 transition-colors duration-300">

    <div class="w-full max-w-xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-[32px] p-8 flex flex-col items-center text-center shadow-2xl">
        <h1 class="text-3xl font-black text-blue-600 dark:text-blue-500 tracking-tighter uppercase mb-1">HASAN TELECOM</h1>
        <p id="modeIndicator" class="text-[10px] text-slate-400 font-bold tracking-[0.2em] uppercase mb-6">STAFF VIEW MODE</p>
        <div class="flex items-center gap-4">
            <button onclick="toggleTheme()" class="bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-4 rounded-2xl hover:scale-105 transition">
                <span id="themeIcon" class="text-xl">üåô</span>
            </button>
            <button id="adminBtn" onclick="toggleAdmin()" class="bg-blue-600 text-white px-10 py-4 rounded-2xl font-black uppercase text-sm tracking-widest shadow-lg hover:bg-blue-500 transition">LOGIN</button>
            <div id="adminTools" class="hidden flex gap-2">
                <button onclick="generatePDF()" title="Export PDF" class="bg-orange-600 p-4 rounded-2xl text-white shadow-lg">üìÑ</button>
                <button onclick="downloadBackup()" title="Backup Database" class="bg-emerald-600 p-4 rounded-2xl text-white shadow-lg">üíæ</button>
                <button onclick="logout()" title="Logout" class="bg-red-600 p-4 rounded-2xl text-white shadow-lg">‚úï</button>
            </div>
        </div>
    </div>

    <div id="statsPanel" class="hidden w-full max-w-xl grid grid-cols-3 gap-3">
        <div class="bg-white dark:bg-slate-900 p-4 rounded-2xl border border-slate-200 dark:border-slate-800 text-center">
            <p class="text-[10px] text-slate-400 font-bold uppercase">Total Items</p>
            <p id="statTotal" class="text-xl font-black text-blue-500">0</p>
        </div>
        <div class="bg-white dark:bg-slate-900 p-4 rounded-2xl border border-slate-200 dark:border-slate-800 text-center">
            <p class="text-[10px] text-slate-400 font-bold uppercase">Out of Stock</p>
            <p id="statLow" class="text-xl font-black text-red-500">0</p>
        </div>
        <div class="bg-white dark:bg-slate-900 p-4 rounded-2xl border border-slate-200 dark:border-slate-800 text-center">
            <p class="text-[10px] text-slate-400 font-bold uppercase">Brands</p>
            <p id="statBrands" class="text-xl font-black text-emerald-500">0</p>
        </div>
    </div>

    <div id="adminPanel" class="hidden w-full max-w-xl bg-white dark:bg-slate-900 p-6 rounded-[32px] border-2 border-blue-600 shadow-2xl space-y-4">
        <div class="grid grid-cols-2 gap-4">
            <select id="modelBrand" class="bg-slate-100 dark:bg-slate-800 p-4 rounded-xl outline-none font-bold dark:text-white"></select>
            <select id="modelCategory" class="bg-slate-100 dark:bg-slate-800 p-4 rounded-xl outline-none font-bold dark:text-white"></select>
        </div>
        <textarea id="bulkInput" rows="3" placeholder="Paste: Model Name, Price (One per line)" class="w-full bg-slate-100 dark:bg-slate-800 p-4 rounded-xl outline-none font-mono text-sm dark:text-white"></textarea>
        <div class="grid grid-cols-2 gap-4">
            <button onclick="addOrUpdate()" class="bg-blue-600 text-white py-4 rounded-2xl font-black uppercase tracking-widest hover:bg-blue-500 transition">SAVE DATA</button>
            <label class="bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-white py-4 rounded-2xl font-black uppercase text-center cursor-pointer text-xs flex items-center justify-center hover:bg-slate-600 transition">
                IMPORT FILE <input type="file" id="importFile" class="hidden" onchange="importBackup(event)">
            </label>
        </div>
    </div>

    <div class="w-full max-w-xl bg-white dark:bg-slate-900/50 border border-slate-200 dark:border-slate-800 rounded-[32px] p-6 space-y-4 shadow-xl">
        <div class="relative">
            <input type="text" id="searchInput" oninput="debouncedRender()" placeholder="Search model (e.g. S21 Ultra)..." class="w-full bg-slate-100 dark:bg-slate-950 border border-slate-200 dark:border-slate-700 p-5 rounded-2xl outline-none focus:ring-2 focus:ring-blue-500 dark:text-white font-medium">
            <span class="absolute right-5 top-5 opacity-20">üîç</span>
        </div>
        <select id="filterBrand" onchange="render()" class="w-full bg-slate-100 dark:bg-slate-800 p-5 rounded-2xl font-black text-orange-600 dark:text-orange-500 outline-none cursor-pointer"></select>
    </div>

    <div id="vaultContent" class="w-full max-w-xl space-y-3 pb-20"></div>
    <div id="emptyState" class="hidden p-20 text-center text-slate-400 font-bold uppercase text-xs italic">No items found matching your search</div>

    <script>
        // APP CONFIG
        const ADMIN_KEY_ENCODED = "MTIzNA=="; // "1234" encoded
        const BRANDS = ["SAMSUNG", "XIAOMI", "OPPO", "VIVO", "REALME", "IPHONE", "HUAWEI", "ONEPLUS", "ITEL", "TECNO", "INFINIX","GOOGLE PIXEL", "SYMPHONY", "NOKIA", "MOTOROLA", "NOTHING PHONE"];
        const CATEGORIES = ["Logic Board", "Front Camera", "Main Flex", "LCD Flex", "Finger Sensor", "Ringer Box", "Ear Speaker", "Sim Tray", "Power Flex", "Volume Flex", "Rubber switch", "Camera Glass", "Speaker Net", "Middle Frame", "Housing", "Back Part"];

        let data = JSON.parse(localStorage.getItem('ht_vault_v2')) || [];
        let isAdmin = false;
        let expandedModels = new Set();
        let searchTimer;

        // --- UTILITIES ---
        function toTitleCase(s) { return s.toLowerCase().split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' '); }
        
        function toggleTheme() {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            document.getElementById('themeIcon').innerText = isDark ? '‚òÄÔ∏è' : 'üåô';
        }
        if (localStorage.theme === 'light') { document.documentElement.classList.remove('dark'); }

        // --- AUTHENTICATION ---
        function toggleAdmin() {
            const p = prompt("Enter Admin Key:");
            if (p && btoa(p) === ADMIN_KEY_ENCODED) { 
                isAdmin = true; 
                updateUI(); 
            } else if (p !== null) {
                alert("Access Denied");
            }
        }
        function logout() { isAdmin = false; updateUI(); }

        function updateUI() {
            document.getElementById('adminPanel').classList.toggle('hidden', !isAdmin);
            document.getElementById('adminTools').classList.toggle('hidden', !isAdmin);
            document.getElementById('statsPanel').classList.toggle('hidden', !isAdmin);
            document.getElementById('adminBtn').classList.toggle('hidden', isAdmin);
            document.getElementById('modeIndicator').innerText = isAdmin ? "ADMIN AUTHORIZED" : "STAFF VIEW MODE";
            render();
        }

        // --- DATA MANAGEMENT ---
        function addOrUpdate() {
            const bulk = document.getElementById('bulkInput').value;
            const brand = document.getElementById('modelBrand').value;
            const cat = document.getElementById('modelCategory').value;

            bulk.split('\n').forEach(line => {
                if(!line.trim()) return;
                let [rawName, price = "Contact"] = line.split(',').map(s => s.trim());
                const name = toTitleCase(rawName);
                
                const existing = data.find(i => i.name.toLowerCase() === name.toLowerCase() && i.cat === cat && i.brand === brand);
                
                if (existing) {
                    existing.price = price;
                } else {
                    data.push({ id: Date.now() + Math.random(), name, price, cat, brand, inStock: true });
                }
            });
            saveAndRender();
            document.getElementById('bulkInput').value = '';
            alert("Database Updated!");
        }

        // --- HIGH PERFORMANCE RENDERING ---
        function debouncedRender() {
            clearTimeout(searchTimer);
            searchTimer = setTimeout(render, 150); // Wait 150ms after typing stops
        }

        function render() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const brandFilter = document.getElementById('filterBrand').value;
            const container = document.getElementById('vaultContent');
            
            // First Load: Populate Dropdowns
            if(!document.getElementById('modelBrand').innerHTML) {
                document.getElementById('modelBrand').innerHTML = BRANDS.map(b => `<option value="${b}">${b}</option>`).join('');
                document.getElementById('modelCategory').innerHTML = CATEGORIES.map(c => `<option value="${c}">${c}</option>`).join('');
                document.getElementById('filterBrand').innerHTML = `<option value="ALL">ALL BRANDS</option>` + BRANDS.map(b => `<option value="${b}">${b}</option>`).join('');
            }

            // Smart Search & Stats Calculation
            const searchTerms = search.split(' ').filter(t => t !== '');
            let outCount = 0;
            const brandsFound = new Set();

            const filtered = data.filter(i => {
                const blob = `${i.brand} ${i.name} ${i.cat}`.toLowerCase();
                const match = searchTerms.every(t => blob.includes(t)) && (brandFilter === "ALL" || i.brand === brandFilter);
                if (match) {
                    if(!i.inStock) outCount++;
                    brandsFound.add(i.brand);
                }
                return match;
            });

            // Update Stats
            if(isAdmin) {
                document.getElementById('statTotal').innerText = filtered.length;
                document.getElementById('statLow').innerText = outCount;
                document.getElementById('statBrands').innerText = brandsFound.size;
            }

            // Group by Model Name
            const groups = filtered.reduce((acc, item) => {
                (acc[item.name] = acc[item.name] || []).push(item);
                return acc;
            }, {});

            // BUILD HTML BUFFER (Fastest Method)
            let htmlBuffer = '';
            const sortedModels = Object.keys(groups).sort();

            sortedModels.forEach(modelName => {
                const items = groups[modelName];
                const isExpanded = expandedModels.has(modelName);
                const brand = items[0].brand;

                htmlBuffer += `
                    <div class="bg-white dark:bg-slate-900 rounded-[24px] border border-slate-200 dark:border-slate-800 overflow-hidden shadow-sm hover:shadow-md transition-shadow">
                        <div onclick="toggleModel('${modelName}')" class="group-header p-5 flex justify-between items-center select-none">
                            <div class="flex flex-col gap-1">
                                <span class="w-fit text-[9px] font-black text-orange-500 uppercase tracking-widest bg-orange-50 dark:bg-orange-900/20 px-2 py-1 rounded-md border border-orange-100 dark:border-orange-800">${brand}</span>
                                <h3 class="text-lg font-bold dark:text-white">${modelName}</h3>
                            </div>
                            <span class="transform transition-transform duration-300 ${isExpanded ? 'rotate-180' : ''} opacity-30">‚ñº</span>
                        </div>
                        
                        <div class="${isExpanded ? 'block' : 'hidden'} border-t border-slate-100 dark:border-slate-800 bg-slate-50 dark:bg-slate-950/50">
                            <table class="w-full text-sm">
                                <tbody class="divide-y divide-slate-200 dark:divide-slate-800">
                                    ${items.map(item => `
                                        <tr>
                                            <td class="px-6 py-4 font-bold text-slate-600 dark:text-slate-400 text-xs uppercase w-1/3">${item.cat}</td>
                                            <td onclick="toggleStock(${item.id})" class="px-2 py-4 cursor-pointer text-[9px] font-black w-1/3 text-center select-none">
                                                ${item.inStock ? '<span class="bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400 px-2 py-1 rounded-full">IN STOCK</span>' : '<span class="bg-red-100 dark:bg-red-900/30 text-red-500 px-2 py-1 rounded-full">OUT OF STOCK</span>'}
                                            </td>
                                            <td class="px-6 py-4 text-right font-mono font-bold text-blue-600 dark:text-blue-400 w-1/3">
                                                ${(item.price === "Contact" && isAdmin) ? `<button onclick="modifyPrice(${item.id})" class="bg-blue-600 hover:bg-blue-500 text-[10px] text-white px-3 py-1 rounded-lg font-bold transition">SET PRICE</button>` : '‡ß≥'+item.price}
                                            </td>
                                            ${isAdmin ? `<td class="w-10 pr-4 text-right"><button onclick="deleteItem(${item.id})" class="text-red-400 hover:text-red-600 font-bold px-2 py-1">‚úï</button></td>` : ''}
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = htmlBuffer;
            document.getElementById('emptyState').classList.toggle('hidden', filtered.length > 0);
        }

        // --- ACTIONS ---
        function modifyPrice(id) {
            const p = prompt("Enter New Price (Numbers only):");
            if (p !== null) {
                const i = data.find(x => x.id === id);
                if (i) { i.price = p.trim() || "Contact"; saveAndRender(); }
            }
        }

        function toggleStock(id) {
            if(!isAdmin) return; 
            const i = data.find(x => x.id === id);
            if(i) { i.inStock = !i.inStock; saveAndRender(); }
        }

        function deleteItem(id) {
            if(confirm("Are you sure you want to delete this item?")) {
                data = data.filter(x => x.id !== id);
                saveAndRender();
            }
        }

        function toggleModel(m) {
            if(expandedModels.has(m)) expandedModels.delete(m);
            else expandedModels.add(m);
            render();
        }

        function saveAndRender() {
            localStorage.setItem('ht_vault_v2', JSON.stringify(data));
            render();
        }

        // --- EXPORT / IMPORT ---
        function downloadBackup() {
            const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `HT_Backup_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
        }

        function importBackup(e) {
            const reader = new FileReader();
            reader.onload = (ev) => {
                try {
                    const imported = JSON.parse(ev.target.result);
                    if(confirm(`Replace current database with ${imported.length} items from backup?`)) {
                        data = imported;
                        saveAndRender();
                        alert("Restore Successful!");
                    }
                } catch(err) { alert("Error: Invalid Backup File"); }
            };
            reader.readAsText(e.target.files[0]);
        }

        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const search = document.getElementById('searchInput').value.toLowerCase();
            const reportRows = data
                .filter(i => `${i.brand} ${i.name} ${i.cat}`.toLowerCase().includes(search))
                .sort((a,b) => a.brand.localeCompare(b.brand))
                .map(i => [i.brand, i.name, i.cat, i.inStock?"YES":"NO", i.price]);

            doc.setFillColor(37, 99, 235);
            doc.rect(0, 0, 210, 20, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(16);
            doc.text("HASAN TELECOM - INVENTORY REPORT", 14, 13);
            
            doc.autoTable({
                head: [['Brand', 'Model', 'Category', 'Stock', 'Price']],
                body: reportRows,
                startY: 25,
                theme: 'grid',
                headStyles: { fillColor: [37, 99, 235] },
                alternateRowStyles: { fillColor: [240, 245, 255] }
            });
            doc.save("HasanTelecom_Inventory.pdf");
        }

        // Initialize
        render();
    </script>
</body>
</html>
